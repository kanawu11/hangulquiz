<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>éŸ“å›½èªãƒ•ãƒ©ãƒƒã‚·ãƒ¥ã‚«ãƒ¼ãƒ‰ã‚²ãƒ¼ãƒ </title>
  <style>
    :root{
      --primaryA:#667eea; --primaryB:#764ba2;
      --greenA:#4CAF50; --greenB:#45a049;
      --redA:#f44336; --redB:#d32f2f;
      --blueA:#3498db; --blueB:#2980b9;
      --cardW:420px; --cardH:260px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; padding:24px; min-height:100%;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, 'Noto Sans', Arial, sans-serif;
      background:linear-gradient(135deg,var(--primaryA) 0%,var(--primaryB) 100%);
      color:#333;
    }
    .container{max-width:900px;margin:0 auto;text-align:center}
    h1{color:#fff;margin:8px 0 20px;font-size:2.1rem;text-shadow:2px 2px 4px rgba(0,0,0,.3)}
    .progress-bar{background:rgba(255,255,255,.2);border-radius:20px;padding:4px;margin-bottom:16px;backdrop-filter:blur(10px)}
    .progress-fill{
      background:linear-gradient(90deg,var(--greenA),var(--greenB));
      height:20px;border-radius:16px;transition:width .5s ease;
      display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:.9rem
    }
    .row{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin:8px 0}
    .card-container{perspective:1200px;margin:18px auto;width:var(--cardW);height:var(--cardH)}
    .flashcard{
      width:100%;height:100%;position:relative;transform-style:preserve-3d;
      transition:transform .6s cubic-bezier(.2,.6,.2,1);cursor:pointer;outline:none
    }
    .flashcard:focus{box-shadow:0 0 0 3px rgba(255,255,255,.5);border-radius:20px}
    .flashcard.flipped{transform:rotateY(180deg)}
    .card-face{
      position:absolute;inset:0;backface-visibility:hidden;border-radius:20px;
      display:flex;align-items:center;justify-content:center;text-align:center;
      font-size:1.9rem;font-weight:800;box-shadow:0 16px 36px rgba(0,0,0,.35);
      padding:20px;color:#fff; text-wrap:balance;
    }
    .card-front{background:linear-gradient(135deg,#e74c3c,#c0392b)}
    .card-back{background:linear-gradient(135deg,var(--blueA),var(--blueB));transform:rotateY(180deg)}
    .controls{
      margin:14px 0;display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));
      gap:10px;align-items:stretch;justify-items:center
    }
    button{
      background:linear-gradient(135deg,var(--primaryA),var(--primaryB));color:#fff;border:none;
      padding:12px 16px;border-radius:22px;font-size:1rem;font-weight:700;cursor:pointer;
      transition:transform .18s ease, box-shadow .18s ease; box-shadow:0 4px 14px rgba(0,0,0,.22);
      width:100%; max-width:220px
    }
    button:hover{transform:translateY(-2px);box-shadow:0 7px 20px rgba(0,0,0,.28)}
    button:active{transform:translateY(0)}
    button:disabled{opacity:.6;cursor:not-allowed}
    .correct{background:linear-gradient(135deg,var(--greenA),var(--greenB))!important}
    .incorrect{background:linear-gradient(135deg,var(--redA),var(--redB))!important}
    .pill{padding:10px 14px;border-radius:999px;background:rgba(255,255,255,.18)}
    .stats{background:rgba(255,255,255,.12);backdrop-filter:blur(10px);border-radius:15px;padding:16px;margin:16px 0;color:#fff}
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:14px;margin-top:8px}
    .stat-item{text-align:center}
    .stat-number{font-size:1.7rem;font-weight:800;display:block}
    .stat-label{font-size:.9rem;opacity:.85}
    .panel{
      background:rgba(255,255,255,.14);backdrop-filter:blur(10px);border-radius:14px;padding:14px;color:#fff;
      min-width:260px; flex:1;
    }
    .panel h3{margin:0 0 8px;font-size:1.05rem}
    .panel small{opacity:.9}
    .panel label{display:flex;align-items:center;gap:8px;justify-content:center;flex-wrap:wrap;margin:6px 0}
    input[type="range"]{width:180px}
    input[type="url"], input[type="text"]{
      padding:8px 10px;border-radius:10px;border:none;min-width:260px
    }
    .screen{display:none}
    .screen.active{display:block}
    .hero{
      background:rgba(255,255,255,.14);border-radius:18px;padding:18px;color:#fff;backdrop-filter:blur(10px);
      margin:10px 0;
    }
    .completion-message{background:linear-gradient(135deg,var(--greenA),var(--greenB));color:#fff;padding:18px;border-radius:15px;margin:14px 0;font-size:1.05rem;font-weight:800}
    /* feedback animations */
    @keyframes pulseWin{
      0%{transform:scale(1)}
      30%{transform:scale(1.03)}
      100%{transform:scale(1)}
    }
    @keyframes shakeLose{
      0%,100%{transform:translateX(0)}
      25%{transform:translateX(-8px)}
      50%{transform:translateX(8px)}
      75%{transform:translateX(-4px)}
    }
    .pulse{animation:pulseWin .32s ease}
    .shake{animation:shakeLose .32s ease}
    @media (max-width:520px){
      .card-container{width:92%;height:210px}
      .card-face{font-size:1.46rem}
      h1{font-size:1.7rem}
    }
  </style>
</head>
<body>
  <main class="container">
    <h1>ğŸ‡°ğŸ‡· éŸ“å›½èªæŒ¨æ‹¶ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ã‚«ãƒ¼ãƒ‰</h1>

    <!-- ========= Home Screen ========= -->
    <section id="homeScreen" class="screen active" aria-labelledby="homeTitle">
      <div class="hero">
        <h2 id="homeTitle" style="margin:0 0 4px">ì‹œì‘í•˜ê¸°</h2>
        <p style="margin:6px 0 10px;opacity:.95">ì¹´ë“œë¥¼ ë’¤ì§‘ìœ¼ë©° í•œêµ­ì–´ ì¸ì‚¬ë¥¼ ìµí˜€ìš”. ì™¸ë¶€ JSONìœ¼ë¡œ ì„¸íŠ¸ë¥¼ ë°”ê¿€ ìˆ˜ë„ ìˆì–´ìš”.</p>
        <div class="row">
          <button id="btnStart">ê²Œì„ ì‹œì‘</button>
          <button id="btnStartShuffle" class="pill" style="max-width:220px">ì…”í”Œë¡œ ì‹œì‘</button>
        </div>
        <div class="row" style="margin-top:4px">
          <input type="url" id="homeJsonUrl" placeholder="ì˜ˆ: /data/greetings.json"/>
          <button id="homeLoadUrl" class="pill">URL ë¶ˆëŸ¬ì™€ì„œ ì‹œì‘</button>
        </div>
        <div class="row" style="margin-top:4px">
          <input type="file" id="homeJsonFile" accept="application/json"/>
          <button id="homeLoadFile" class="pill">íŒŒì¼ ë¶ˆëŸ¬ì™€ì„œ ì‹œì‘</button>
        </div>
      </div>

      <div class="row">
        <!-- ì˜µì…˜ ìš”ì•½ íŒ¨ë„ -->
        <div class="panel">
          <h3>â±ï¸ ìë™ ë„˜ê¹€ & íš¨ê³¼ìŒ</h3>
          <label><input type="checkbox" id="autoAdvance" checked/> ì •ë‹µ/ì˜¤ë‹µ í›„ ìë™ ë‹¤ìŒ</label>
          <label>ë”œë ˆì´: <input type="range" id="delayRange" min="0" max="2500" step="100" value="800"/>
            <span id="delayLabel">0.8ì´ˆ</span>
          </label>
          <label><input type="checkbox" id="soundOn" checked/> íš¨ê³¼ìŒ ì‚¬ìš©</label>
        </div>

        <div class="panel">
          <h3>ğŸ—£ï¸ ë°œìŒ(TTS)</h3>
          <label><input type="checkbox" id="autoSpeak"/> ë’¤ì§‘ì„ ë•Œ ìë™ ë°œìŒ</label>
          <small>ì•ë©´: ì¼ë³¸ì–´ / ë’·ë©´: í•œêµ­ì–´</small>
        </div>

        <div class="panel">
          <h3>ğŸƒ ì…”í”Œ & ë°ì´í„°</h3>
          <label><input type="checkbox" id="shuffleOn" checked/> ìƒˆ ê²Œì„ ì‹œì‘ ì‹œ ì…”í”Œ</label>
          <small>í™ˆ ë˜ëŠ” ê²Œì„ í™”ë©´ì—ì„œ JSONì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ìˆì–´ìš”.</small>
        </div>
      </div>
    </section>

    <!-- ========= Game Screen ========= -->
    <section id="gameScreen" class="screen" aria-live="polite">
      <div class="progress-bar" aria-label="ì§„í–‰ë¥ ">
        <div class="progress-fill" id="progressFill" style="width:0%">0 / 0</div>
      </div>

      <div class="card-container">
        <div class="flashcard" id="flashcard" role="button" tabindex="0" aria-pressed="false" aria-label="ì¹´ë“œ ë’¤ì§‘ê¸°">
          <div class="card-face card-front" id="cardFront">ã‚«ãƒ¼ãƒ‰ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦å§‹ã‚ã¾ã—ã‚‡ã†ï¼</div>
          <div class="card-face card-back" id="cardBack">ì‹œì‘í•´ìš”!</div>
        </div>
      </div>

      <div class="controls" aria-label="ë©”ì¸ ì»¨íŠ¸ë¡¤">
        <button id="btnFlip" type="button">ã‚«ãƒ¼ãƒ‰ã‚’ã‚ãã‚‹</button>
        <button id="btnCorrect" type="button" class="correct">æ­£è§£ âœ“</button>
        <button id="btnIncorrect" type="button" class="incorrect">ä¸æ­£è§£ âœ—</button>
        <button id="btnNext" type="button">æ¬¡ã®ã‚«ãƒ¼ãƒ‰</button>
        <button id="btnShuffle" type="button" class="pill">ã‚·ãƒ£ãƒƒãƒ•ãƒ«</button>
        <button id="btnReset" type="button">ãƒªã‚»ãƒƒãƒˆ</button>
      </div>

      <div class="row">
        <div class="panel">
          <h3>ğŸ”Š ë°œìŒ</h3>
          <div class="row" style="gap:8px;justify-content:center">
            <button id="speakFront" class="pill" type="button">ì•ë©´ ì½ê¸°(æ—¥æœ¬èª)</button>
            <button id="speakBack" class="pill" type="button">ë’·ë©´ ì½ê¸°(í•œêµ­ì–´)</button>
          </div>
        </div>
        <div class="panel" style="min-width:280px">
          <h3>ğŸŒ ì™¸ë¶€ JSON</h3>
          <div class="row" style="gap:6px;justify-content:center">
            <input type="url" id="jsonUrl" placeholder="ì˜ˆ: /data/greetings.json"/>
            <button id="btnLoadUrl" class="pill" type="button">URL ë¶ˆëŸ¬ì˜¤ê¸°</button>
          </div>
          <div class="row" style="gap:6px;justify-content:center">
            <input type="file" id="jsonFile" accept="application/json"/>
            <button id="btnLoadFile" class="pill" type="button">íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°</button>
          </div>
        </div>
      </div>

      <div class="stats" aria-label="í•™ìŠµ í†µê³„">
        <div class="stats-grid">
          <div class="stat-item">
            <span class="stat-number" id="correctCount">0</span>
            <span class="stat-label">æ­£è§£</span>
          </div>
          <div class="stat-item">
            <span class="stat-number" id="incorrectCount">0</span>
            <span class="stat-label">ä¸æ­£è§£</span>
          </div>
          <div class="stat-item">
            <span class="stat-number" id="accuracyRate">0%</span>
            <span class="stat-label">æ­£è§£ç‡</span>
          </div>
          <div class="stat-item">
            <span class="stat-number" id="currentCard">0</span>
            <span class="stat-label">ç¾åœ¨ã®ã‚«ãƒ¼ãƒ‰</span>
          </div>
        </div>
      </div>
    </section>

    <!-- ========= Result Screen ========= -->
    <section id="resultScreen" class="screen" aria-labelledby="resultTitle">
      <div class="completion-message">ğŸ‰ ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼ã™ã¹ã¦ã®ã‚«ãƒ¼ãƒ‰ã‚’å®Œäº†ã—ã¾ã—ãŸï¼</div>
      <h2 id="resultTitle" style="color:#fff;margin:6px 0 10px">ê²°ê³¼ ìš”ì•½</h2>

      <div class="stats">
        <div class="stats-grid">
          <div class="stat-item">
            <span class="stat-number" id="rTotal">0</span>
            <span class="stat-label">ì´ ì¹´ë“œ</span>
          </div>
          <div class="stat-item">
            <span class="stat-number" id="rCorrect">0</span>
            <span class="stat-label">ì •ë‹µ</span>
          </div>
          <div class="stat-item">
            <span class="stat-number" id="rIncorrect">0</span>
            <span class="stat-label">ì˜¤ë‹µ</span>
          </div>
          <div class="stat-item">
            <span class="stat-number" id="rAccuracy">0%</span>
            <span class="stat-label">ì •ë‹µë¥ </span>
          </div>
        </div>
      </div>

      <div class="controls" style="margin-top:10px">
        <button id="btnReplayAll">ë‹¤ì‹œí•˜ê¸° (ì „ì²´)</button>
        <button id="btnReviewWrong" class="incorrect">í‹€ë¦° ê²ƒë§Œ ë³µìŠµ</button>
        <button id="btnGoHome" class="pill">í™ˆìœ¼ë¡œ</button>
      </div>
    </section>
  </main>

  <script>
    // ====== ì´ˆê¸° ì¹´ë“œ ë°ì´í„° (í´ë°±) ======
    let baseDeck = [
      { front: "ã“ã‚“ã«ã¡ã¯", back: "ì•ˆë…•í•˜ì„¸ìš”" },
      { front: "ãŠã¯ã‚ˆã†ã”ã–ã„ã¾ã™", back: "ì¢‹ì€ ì•„ì¹¨ì…ë‹ˆë‹¤" },
      { front: "ã“ã‚“ã°ã‚“ã¯", back: "ì¢‹ì€ ì €ë…ì…ë‹ˆë‹¤" },
      { front: "ã•ã‚ˆã†ãªã‚‰", back: "ì•ˆë…•íˆ ê°€ì„¸ìš”" },
      { front: "ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™", back: "ê°ì‚¬í•©ë‹ˆë‹¤" }
    ];

    // í˜„ì¬ í”Œë ˆì´ ì¤‘ì¸ ë±
    let deck = baseDeck.slice();

    // ====== ìƒíƒœ ë³€ìˆ˜ ======
    let idx = 0;
    let correct = 0;
    let incorrect = 0;
    let flipped = false;
    let completed = new Set();      // ì •ë‹µ ì²˜ë¦¬ëœ ì¸ë±ìŠ¤
    let wrongIndexes = new Set();   // ì˜¤ë‹µ ì²˜ë¦¬ëœ ì›ë³¸ ì¸ë±ìŠ¤
    let lock = false;               // ìë™ë„˜ê¹€ ë™ì•ˆ ì…ë ¥ ì ê¸ˆ
    let lastTimer = null;

    // ====== ì—˜ë¦¬ë¨¼íŠ¸ ======
    const flashcard = document.getElementById('flashcard');
    const cardFront = document.getElementById('cardFront');
    const cardBack  = document.getElementById('cardBack');
    const progressFill = document.getElementById('progressFill');
    const correctCount = document.getElementById('correctCount');
    const incorrectCount = document.getElementById('incorrectCount');
    const accuracyRate  = document.getElementById('accuracyRate');
    const currentCardDisplay = document.getElementById('currentCard');

    // ìŠ¤í¬ë¦°
    const homeScreen = document.getElementById('homeScreen');
    const gameScreen = document.getElementById('gameScreen');
    const resultScreen = document.getElementById('resultScreen');

    // í™ˆ ì»¨íŠ¸ë¡¤
    const btnStart = document.getElementById('btnStart');
    const btnStartShuffle = document.getElementById('btnStartShuffle');
    const homeJsonUrl = document.getElementById('homeJsonUrl');
    const homeLoadUrl = document.getElementById('homeLoadUrl');
    const homeJsonFile = document.getElementById('homeJsonFile');
    const homeLoadFile = document.getElementById('homeLoadFile');

    // ê²Œì„ ì»¨íŠ¸ë¡¤
    const btnFlip = document.getElementById('btnFlip');
    const btnCorrect = document.getElementById('btnCorrect');
    const btnIncorrect = document.getElementById('btnIncorrect');
    const btnNext = document.getElementById('btnNext');
    const btnReset = document.getElementById('btnReset');
    const btnShuffle = document.getElementById('btnShuffle');

    // ì˜µì…˜
    const autoAdvance = document.getElementById('autoAdvance');
    const delayRange = document.getElementById('delayRange');
    const delayLabel = document.getElementById('delayLabel');
    const soundOn = document.getElementById('soundOn');
    const autoSpeak = document.getElementById('autoSpeak');
    const shuffleOn = document.getElementById('shuffleOn');

    // TTS
    const speakFrontBtn = document.getElementById('speakFront');
    const speakBackBtn  = document.getElementById('speakBack');

    // ì™¸ë¶€ JSON (ê²Œì„ í™”ë©´)
    const jsonUrl = document.getElementById('jsonUrl');
    const btnLoadUrl = document.getElementById('btnLoadUrl');
    const jsonFile = document.getElementById('jsonFile');
    const btnLoadFile = document.getElementById('btnLoadFile');

    // ê²°ê³¼ í™”ë©´
    const rTotal = document.getElementById('rTotal');
    const rCorrect = document.getElementById('rCorrect');
    const rIncorrect = document.getElementById('rIncorrect');
    const rAccuracy = document.getElementById('rAccuracy');
    const btnReplayAll = document.getElementById('btnReplayAll');
    const btnReviewWrong = document.getElementById('btnReviewWrong');
    const btnGoHome = document.getElementById('btnGoHome');

    // ====== ìœ í‹¸ ======
    function showScreen(el){
      for(const s of [homeScreen, gameScreen, resultScreen]) s.classList.remove('active');
      el.classList.add('active');
    }
    function clamp(n, min, max){ return Math.max(min, Math.min(max, n)); }
    function shuffleArray(arr){
      for(let i=arr.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [arr[i],arr[j]] = [arr[j],arr[i]];
      }
      return arr;
    }
    function updateDelayLabel(){
      const ms = parseInt(delayRange.value,10);
      delayLabel.textContent = (ms/1000).toFixed(1) + 'ì´ˆ';
    }
    function speak(text, lang){
      if(!text) return;
      if(!('speechSynthesis' in window)) return;
      const u = new SpeechSynthesisUtterance(text);
      u.lang = lang;
      u.rate = 1.0; u.pitch = 1.0;
      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(u);
    }

    // WebAudio íš¨ê³¼ìŒ
    let audioCtx = null;
    function beepGood(){
      if(!soundOn.checked) return;
      if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type='sine'; o.frequency.setValueAtTime(880, audioCtx.currentTime);
      g.gain.setValueAtTime(0.0001, audioCtx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.4, audioCtx.currentTime+0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime+0.20);
      o.connect(g).connect(audioCtx.destination);
      o.start(); o.stop(audioCtx.currentTime+0.22);
    }
    function beepBad(){
      if(!soundOn.checked) return;
      if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type='square'; o.frequency.setValueAtTime(220, audioCtx.currentTime);
      g.gain.setValueAtTime(0.0001, audioCtx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.35, audioCtx.currentTime+0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime+0.25);
      o.connect(g).connect(audioCtx.destination);
      o.start(); o.stop(audioCtx.currentTime+0.27);
    }

    function validateDeck(json){
      // [{front:string, back:string}]
      if(!Array.isArray(json)) return false;
      return json.every(x => x && typeof x.front==='string' && typeof x.back==='string');
    }

    // ====== ì½”ì–´ ë¡œì§ ======
    function loadCard(){
      const c = deck[idx];
      cardFront.textContent = c?.front ?? '';
      cardBack.textContent  = c?.back ?? '';
      flipped = false;
      flashcard.classList.remove('flipped','pulse','shake');
      flashcard.setAttribute('aria-pressed','false');
      updateDisplay();
      if(autoSpeak.checked) speak(deck[idx]?.front,'ja-JP');
    }

    function flipCard(){
      if(lock) return;
      flipped = !flipped;
      flashcard.classList.toggle('flipped');
      flashcard.setAttribute('aria-pressed', flipped?'true':'false');
      if(autoSpeak.checked){
        if(flipped) speak(deck[idx]?.back, 'ko-KR'); else speak(deck[idx]?.front, 'ja-JP');
      }
    }

    function markCorrect(){
      if(lock) return;
      correct++; completed.add(idx);
      flashcard.classList.remove('shake');
      flashcard.classList.add('pulse');
      updateStats(); beepGood();
      endOrAdvance();
    }

    function markIncorrect(){
      if(lock) return;
      incorrect++; wrongIndexes.add(idx);
      flashcard.classList.remove('pulse');
      flashcard.classList.add('shake');
      updateStats(); beepBad();
      endOrAdvance();
    }

    function endOrAdvance(){
      if (autoAdvance.checked) advanceWithDelay(); else checkCompletion();
    }

    function nextCard(){
      if(lock) return;
      idx = (idx + 1) % deck.length;
      loadCard();
      checkCompletion();
    }

    function checkCompletion(){
      if (completed.size === deck.length){
        const total = correct + incorrect;
        const acc = total>0 ? Math.round((correct/total)*100) : 0;
        document.getElementById('rTotal').textContent = deck.length;
        document.getElementById('rCorrect').textContent = correct;
        document.getElementById('rIncorrect').textContent = incorrect;
        document.getElementById('rAccuracy').textContent = acc + '%';
        document.getElementById('btnReviewWrong').disabled = wrongIndexes.size === 0;
        showScreen(resultScreen);
      }
    }

    function advanceWithDelay(){
      const delay = Math.max(0, Math.min(2500, parseInt(delayRange.value,10)));
      lock = true;
      clearTimeout(lastTimer);
      lastTimer = setTimeout(()=>{
        lock = false;
        nextCard();
      }, delay);
    }

    function updateStats(){
      const total = correct + incorrect;
      const acc = total>0 ? Math.round((correct/total)*100) : 0;
      correctCount.textContent = correct;
      incorrectCount.textContent = incorrect;
      accuracyRate.textContent = acc + '%';
    }

    function updateDisplay(){
      currentCardDisplay.textContent = deck.length ? (idx+1) : 0;
      const prog = deck.length ? (completed.size / deck.length) * 100 : 0;
      progressFill.style.width = prog + '%';
      progressFill.textContent = `${completed.size} / ${deck.length}`;
    }

    function resetState(){
      idx = 0; correct = 0; incorrect = 0; flipped = false;
      completed.clear(); wrongIndexes.clear();
      clearTimeout(lastTimer); lock = false;
    }

    function startGame({shuffle=false} = {}){
      deck = baseDeck.slice();
      if (shuffle) deck = shuffleArray(deck);
      resetState();
      showScreen(gameScreen);
      loadCard(); updateStats();
    }

    function replayAll(){
      deck = baseDeck.slice();
      if (document.getElementById('shuffleOn').checked) deck = shuffleArray(deck);
      resetState();
      showScreen(gameScreen);
      loadCard(); updateStats();
    }

    function reviewWrongOnly(){
      if (wrongIndexes.size===0) return;
      const wrongArray = Array.from(wrongIndexes.values());
      const newDeck = wrongArray.map(i => deck[i]).filter(Boolean);
      deck = newDeck.length ? newDeck : deck.slice();
      resetState();
      showScreen(gameScreen);
      loadCard(); updateStats();
    }

    // ====== ì´ë²¤íŠ¸ ë°”ì¸ë”© ======
    btnStart.addEventListener('click', ()=> startGame({shuffle:false}));
    btnStartShuffle.addEventListener('click', ()=> startGame({shuffle:true}));

    homeLoadUrl.addEventListener('click', async ()=>{
      const url = homeJsonUrl.value.trim();
      if(!url) return alert('ë¶ˆëŸ¬ì˜¬ JSON URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      try{
        const res = await fetch(url, {cache:'no-store'});
        if(!res.ok) throw new Error(res.status+' '+res.statusText);
        const data = await res.json();
        if(!validateDeck(data)) throw new Error('JSON ìŠ¤í‚¤ë§ˆê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. [{front, back}] ë°°ì—´ì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
        baseDeck = data.slice();
        startGame({shuffle:true});
      }catch(err){
        console.error(err); alert('JSON ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: '+err.message);
      }
    });

    homeLoadFile.addEventListener('click', async ()=>{
      const f = homeJsonFile.files?.[0];
      if(!f) return alert('ë¶ˆëŸ¬ì˜¬ JSON íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
      try{
        const text = await f.text();
        const data = JSON.parse(text);
        if(!validateDeck(data)) throw new Error('JSON ìŠ¤í‚¤ë§ˆê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. [{front, back}] ë°°ì—´ì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
        baseDeck = data.slice();
        startGame({shuffle:true});
      }catch(err){
        console.error(err); alert('JSON íŒŒì‹± ì‹¤íŒ¨: '+err.message);
      }
    });

    flashcard.addEventListener('click', flipCard);
    flashcard.addEventListener('keydown', (e)=>{
      if(e.key==='Enter' || e.key===' '){ e.preventDefault(); flipCard(); }
    });
    document.getElementById('btnFlip').addEventListener('click', flipCard);
    btnCorrect.addEventListener('click', markCorrect);
    btnIncorrect.addEventListener('click', markIncorrect);
    btnNext.addEventListener('click', nextCard);
    btnReset.addEventListener('click', ()=> { startGame({shuffle:document.getElementById('shuffleOn').checked}); });
    btnShuffle.addEventListener('click', ()=>{ deck = shuffleArray(deck.slice()); resetState(); showScreen(gameScreen); loadCard(); updateStats(); });

    speakFrontBtn.addEventListener('click', ()=> speak(deck[idx]?.front, 'ja-JP'));
    speakBackBtn.addEventListener('click',  ()=> speak(deck[idx]?.back,  'ko-KR'));

    delayRange.addEventListener('input', ()=>{
      const ms = parseInt(delayRange.value,10);
      delayLabel.textContent = (ms/1000).toFixed(1) + 'ì´ˆ';
    });
    (function(){ const ms = parseInt(delayRange.value,10); delayLabel.textContent = (ms/1000).toFixed(1) + 'ì´ˆ'; })();

    btnLoadUrl.addEventListener('click', async ()=>{
      const url = jsonUrl.value.trim();
      if(!url) return alert('ë¶ˆëŸ¬ì˜¬ JSON URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      try{
        const res = await fetch(url, {cache:'no-store'});
        if(!res.ok) throw new Error(res.status+' '+res.statusText);
        const data = await res.json();
        if(!validateDeck(data)) throw new Error('JSON ìŠ¤í‚¤ë§ˆê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. [{front, back}] ë°°ì—´ì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
        baseDeck = data.slice();
        startGame({shuffle:document.getElementById('shuffleOn').checked});
      }catch(err){
        console.error(err); alert('JSON ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: '+err.message);
      }
    });

    btnLoadFile.addEventListener('click', async ()=>{
      const f = jsonFile.files?.[0];
      if(!f) return alert('ë¶ˆëŸ¬ì˜¬ JSON íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
      try{
        const text = await f.text();
        const data = JSON.parse(text);
        if(!validateDeck(data)) throw new Error('JSON ìŠ¤í‚¤ë§ˆê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. [{front, back}] ë°°ì—´ì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
        baseDeck = data.slice();
        startGame({shuffle:document.getElementById('shuffleOn').checked});
      }catch(err){
        console.error(err); alert('JSON íŒŒì‹± ì‹¤íŒ¨: '+err.message);
      }
    });

    document.addEventListener('keydown', (e)=>{
      if(!gameScreen.classList.contains('active')) return;
      if(e.key===' ' || e.key==='Enter'){ e.preventDefault(); flipCard(); }
      else if(e.key==='ArrowRight'){ e.preventDefault(); nextCard(); }
      else if(e.key==='1'){ e.preventDefault(); markCorrect(); }
      else if(e.key==='2'){ e.preventDefault(); markIncorrect(); }
      else if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='r'){ e.preventDefault(); startGame({shuffle:document.getElementById('shuffleOn').checked}); }
    });

    document.getElementById('btnReplayAll').addEventListener('click', replayAll);
    document.getElementById('btnReviewWrong').addEventListener('click', reviewWrongOnly);
    document.getElementById('btnGoHome').addEventListener('click', ()=> showScreen(homeScreen));

    showScreen(homeScreen);
  </script>
</body>
</html>
